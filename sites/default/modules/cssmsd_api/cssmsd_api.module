<?php

/**
 * Implements hook_menu().
 */
function cssmsd_api_menu() {
  $items = array();

  $items['api/user_login'] = array(
    'title' => t('Ajax API testing'),
    'page callback' => '_user_login',
    'type' => MENU_CALLBACK,
    'access callback' => TRUE,
  );

  $items['admin/config/cssmsd/prize'] = array(
    'title' => 'CSSMSD Lucky Set',
    'description' => 'Configure required settings for Lucky',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('cssmsd_api_settings_form'),
    'access arguments' => array('administer site configuration'),
    'file' => 'cssmsd_api.pages.inc',
  );

  $items['api/test'] = array(
    'title' => t('Ajax API testing'),
    'page callback' => '_test',
    'type' => MENU_CALLBACK,
    'access callback' => TRUE,
  );

  return $items;
}

 /**
 * test
 */
 function _test() {

 	_get_prize_by_nid(2)

 	//_retrieve_store_lat_long();
 }

 /**
  *
  * Get prize by nid
  *
  * @param $nid
  * @return term
  *
  */
 function _get_prize_by_nid($nid) {

 	$item_ids = node_load($nid)->field_chowssmsd_store_prize[LANGUAGE_NONE];
 	$prizes = array();

 	foreach($item_ids as $item_id) {
 		$item = field_collection_item_load($item_id['value']);
 		$tid = $item->field_chowssmsd_prize_name[LANGUAGE_NONE][0]['tid'];
 		$quantity = $item->field_chowssmsd_prize_quantity[LANGUAGE_NONE][0]['value'];
 		$used = _get_prize_used_quantity($nid, $tid);
 		if($used < $quantity) {
 			$prizes[] = $tid;
 		}
 	}

	$virtual_tid = array_shift(taxonomy_get_term_by_name('Virtual'))->tid;
	$virtual_prizes = taxonomy_get_children($virtual_tid);

	foreach($virtual_prizes as $prize) {
		if(_get_virtual_prize_quantity($tid) > 0)
			$prizes[] = $tid;
	}

	$probability = split('/', variable_get('cssmsd_api_prize_probability', NULL));
	if(mt_rand(0, $probability[1]) <= $probability[0])
		
 }

 /**
  *
  * Check prize by LBS
  *
  * @param latitude, $longitude
  * @return code
  *
  */
 function _show_prize_by_lbs() {
 	$latitude = $_POST['data']['latitude'];
 	$longitude = $_POST['data']['longitude'];
	$node = _get_nearest_store($latitude, $longitude);

	

 }

 /**
  *
  * Get prize number which has been used
  *
  * @param $nid, $tid
  * @return number string
  *
  */
 function _get_prize_used_quantity($nid, $tid) {
 	return 100;
 }

 /**
  *
  * Get number of virtual prize
  *
  * @param $tid
  * @return number string
  *
  */
 function _get_virtual_prize_quantity($tid) {
 	return 100;
 }
 /**
  *
  * Create prize log
  *
  * @param 
  * @return 
  *
  */
 function _create_prize_log() {

	

 }

 /**
  *
  * Get nearest store by latitude and longitude
  *
  * @param latitude, $longitude
  * @return nid
  *
  */
 function _get_nearest_store($latitude, $longitude) {
	$nodes = node_load_multiple(array(), array('type' => 'chowssmsd_stores'));
	$store = array();
	foreach($nodes as $node){
		$latitude_end = $node->field_chowssmsd_store_latitude[LANGUAGE_NONE][0]['value'];
		$longitude_end = $node->field_chowssmsd_store_longitude[LANGUAGE_NONE][0]['value'];
		$store[$node->nid] = _get_distance_between_points($latitude, $longitude, $latitude_end, $longitude_end);
	}
	asort($store);
 	$nids = array_keys($store);
 	$nid = reset($nids);
 	return $nid;

 }

 /**
  *
  * Get distance between points by latitude and longitude
  *
  * @param $latitude1, $longitude1, $latitude2, $longitude2
  * @return array
  *
  */
function _get_distance_between_points($latitude1, $longitude1, $latitude2, $longitude2) {
    $theta = $longitude1 - $longitude2;
    $miles = (sin(deg2rad($latitude1)) * sin(deg2rad($latitude2))) + (cos(deg2rad($latitude1)) * cos(deg2rad($latitude2)) * cos(deg2rad($theta)));
    $miles = acos($miles);
    $miles = rad2deg($miles);
    $miles = $miles * 60 * 1.1515;
    $meters = $kilometers * 1000;
    return $meters;
}

 /**
  *
  * User Login
  *
  * @param 
  * @return
  *
  */
function _user_login() {

  	global $user;

	if(!$user->uid) {
		$tracking_key = _tracking_key_generate();
		$account = db_query('SELECT 1 FROM {users} WHERE name = :username', array(':username' => $tracking_key))->fetchField();
		if(!$account) {
			// organize user data
			$edit = array();
			$edit['name'] = $tracking_key;
			$edit['mail'] = $edit['init'] = $tracking_key . '@fake.com';
			$edit['status'] = 1;
			$edit['access'] = REQUEST_TIME;
			$user = user_save(NULL, $edit);
			user_login_finalize();  	
		}
	}
}
 /**
  *
  * Generate tracking key.
  *
  * @param 
  * @return uuid
  *
  */
function _tracking_key_generate() {

	global $user;

	$expire_days = 360;

	if(isset($_COOKIE['_ddmstkey'])) 
		return $_COOKIE['_ddmstkey'];

	$tracking_key = uuid_generate();
	setcookie('_ddmstkey', $tracking_key, time() + 3600 * 24 * $expire_days, '/');
	return $tracking_key;

}

